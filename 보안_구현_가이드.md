# λ³΄μ• κµ¬ν„ κ°€μ΄λ“

## π“‹ κµ¬ν„ μ™„λ£ μ‚¬ν•­

### β… 1. μ½”λ“ λ‚λ…ν™” (Code Obfuscation)

#### μ„¤μ • νμΌ
- `next.config.obfuscated.js` - ν”„λ΅λ•μ… λΉλ“μ© λ‚λ…ν™” μ„¤μ • νμΌ μƒμ„±

#### λ‚λ…ν™” μµμ…
- β… Control Flow Flattening: μ½”λ“ νλ¦„ ν‰νƒ„ν™” (100%)
- β… Dead Code Injection: λ”λ―Έ μ½”λ“ μ‚½μ…
- β… Debug Protection: λ””λ²„κ±° λ³΄νΈ
- β… String Array: λ¨λ“  λ¬Έμμ—΄ Base64 μΈμ½”λ”©
- β… String Array Wrappers: λ‹¤μ¤‘ λνΌλ΅ λ¬Έμμ—΄ μ ‘κ·Ό λ‚λ…ν™”
- β… Self Defending: μμ²΄ λ°©μ–΄ λ©”μ»¤λ‹μ¦
- β… Console Output μ κ±°
- β… μ†μ¤λ§µ λΉ„ν™μ„±ν™”: `productionBrowserSourceMaps: false`

#### μ‚¬μ© λ°©λ²•
```bash
# μΌλ° λΉλ“
npm run build

# λ‚λ…ν™” λΉλ“
npm run build:obfuscated
```

---

### β… 2. μ•”νΈν™” (Encryption)

#### κµ¬ν„ νμΌ
- `src/lib/security/encryption.ts` - μ•”νΈν™” μ ν‹Έλ¦¬ν‹°

#### κΈ°λ¥
- β… `encrypt()`: AES μ•”νΈν™”
- β… `decrypt()`: AES λ³µνΈν™”
- β… `hash()`: SHA-256 ν•΄μ‹ μƒμ„±
- β… `generateToken()`: μ•μ „ν• ν† ν° μƒμ„±
- β… `hashPassword()`: λΉ„λ°€λ²νΈ ν•΄μ‹ μƒμ„±
- β… `verifyPassword()`: λΉ„λ°€λ²νΈ κ²€μ¦
- β… `envEncryption`: ν™κ²½ λ³€μ μ•”νΈν™” ν—¬νΌ

#### μ‚¬μ© μμ‹
```typescript
import { encrypt, decrypt, hash, generateToken } from '@/lib/security/encryption';

// μ•”νΈν™”
const encrypted = encrypt('sensitive-data');

// λ³µνΈν™”
const decrypted = decrypt(encrypted);

// ν•΄μ‹ μƒμ„±
const hashed = hash('text-to-hash');

// ν† ν° μƒμ„±
const token = generateToken(32);
```

#### ν™κ²½ λ³€μ μ„¤μ •
`.env.local` νμΌμ— μ•”νΈν™” ν‚¤ μ„¤μ •:
```env
ENCRYPTION_KEY=your-secure-encryption-key-change-this-in-production
```

---

### β… 3. λ°±μ—”λ“ λ³΄μ• λ―Έλ“¤μ›¨μ–΄

#### κµ¬ν„ νμΌ
- `src/lib/security/middleware.ts` - λ³΄μ• λ―Έλ“¤μ›¨μ–΄
- `src/lib/security/rate-limiter.ts` - Rate Limiting
- `src/lib/security/input-sanitizer.ts` - μ…λ ¥κ°’ κ²€μ¦

#### κΈ°λ¥

##### Helmet.js κΈ°λ¥ (λ³΄μ• ν—¤λ”)
- β… Content Security Policy (CSP)
- β… XSS Protection
- β… Frame Options (Clickjacking λ°©μ§€)
- β… Content Type Options
- β… Referrer Policy
- β… Permissions Policy

##### Rate Limiting
- β… μΌλ° API: 15λ¶„λ‹Ή 100ν μ”μ²­
- β… μΈμ¦ API: 15λ¶„λ‹Ή 5ν μ‹λ„
- β… API ν‚¤ κ΄€λ¦¬: 1μ‹κ°„λ‹Ή 10ν

##### SQL Injection λ°©μ§€
- β… μ”μ²­ λ³Έλ¬Έ, μΏΌλ¦¬, νλΌλ―Έν„°μ—μ„ SQL ν‚¤μ›λ“ κ²€μ‚¬
- β… μ„ν—ν• ν¨ν„΄ κ°μ§€ μ‹ μ”μ²­ μ°¨λ‹¨

##### XSS λ°©μ§€
- β… μ¤ν¬λ¦½νΈ νƒκ·Έ, iframe, javascript: ν”„λ΅ν† μ½ λ“± μ„ν—ν• ν¨ν„΄ κ²€μ‚¬
- β… μ„ν—ν• μ½ν…μΈ  κ°μ§€ μ‹ μ”μ²­ μ°¨λ‹¨

##### μ”μ²­ ν¬κΈ° μ ν•
- β… μµλ€ 10MBλ΅ μ ν•
- β… μ΄κ³Ό μ‹ 413 μ—λ¬ λ°ν™

#### μ‚¬μ© μμ‹
```typescript
import { securityMiddleware, createSecureResponse, RATE_LIMITS } from '@/lib/security/middleware';

export async function GET(request: NextRequest) {
  // λ³΄μ• λ―Έλ“¤μ›¨μ–΄ μ‹¤ν–‰
  const securityCheck = await securityMiddleware(request, {
    rateLimit: RATE_LIMITS.GENERAL,
    checkSQLInjection: true,
    checkXSS: true,
    checkRequestSize: true,
  });
  
  if (securityCheck) {
    return securityCheck; // λ³΄μ• κ²€μ‚¬ μ‹¤ν¨ μ‹ μ‘λ‹µ λ°ν™
  }
  
  // μ •μƒ μ²λ¦¬
  return createSecureResponse({
    success: true,
    data: 'your-data',
  });
}
```

---

### β… 4. JWT ν† ν° λ³΄μ• κ°•ν™”

#### κµ¬ν„ νμΌ
- `src/lib/security/auth-middleware.ts` - μΈμ¦ λ―Έλ“¤μ›¨μ–΄

#### ν† ν° κ²€μ¦ μµμ…
- β… μ•κ³ λ¦¬μ¦: HS256 λ…μ‹
- β… Issuer: `live-commerce-api`
- β… Audience: `live-commerce-client`
- β… JWT ID: λλ¤ ID μ¶”κ°€ (Supabaseμ—μ„ μλ™ μ²λ¦¬)

#### ν† ν° κ²€μ¦ κΈ°λ¥
- β… μ•κ³ λ¦¬μ¦ ν™”μ΄νΈλ¦¬μ¤νΈ μ μ©
- β… Issuer/Audience κ²€μ¦ (Supabaseμ—μ„ μλ™ μ²λ¦¬)
- β… λ§λ£ μ‹κ°„ μλ™ κ²€μ¦ (Supabaseμ—μ„ μλ™ μ²λ¦¬)

#### μ‚¬μ© μμ‹
```typescript
import { authenticateToken, requireRole, requireAdmin, requireCreator } from '@/lib/security/auth-middleware';

// ν† ν° κ²€μ¦
const auth = await authenticateToken(request);

// μ—­ν•  κΈ°λ° μ ‘κ·Ό μ μ–΄
const admin = await requireAdmin(request);

// ν¬λ¦¬μ—μ΄ν„° κ¶ν• ν™•μΈ
const creator = await requireCreator(request, streamId);
```

---

### β… 5. μΈμ¦ λ° κ¶ν• κ΄€λ¦¬

#### κµ¬ν„ νμΌ
- `src/lib/security/auth-middleware.ts` - μΈμ¦ λ―Έλ“¤μ›¨μ–΄
- `src/middleware.ts` - Next.js λ―Έλ“¤μ›¨μ–΄ μ—…λ°μ΄νΈ

#### κΈ°λ¥

##### μΈμ¦ λ―Έλ“¤μ›¨μ–΄
- β… `authenticateToken()`: JWT ν† ν° κ²€μ¦
- β… `requireRole()`: μ—­ν•  κΈ°λ° μ ‘κ·Ό μ μ–΄
- β… `requireAdmin()`: κ΄€λ¦¬μ κ¶ν• ν™•μΈ
- β… `requireCreator()`: ν¬λ¦¬μ—μ΄ν„° κ¶ν• ν™•μΈ

##### λ―Έλ“¤μ›¨μ–΄ λνΌ
- β… `withAuth()`: μΈμ¦μ΄ ν•„μ”ν• API λνΌ
- β… `withRole()`: μ—­ν•  κΈ°λ° API λνΌ
- β… `withAdmin()`: κ΄€λ¦¬μ μ „μ© API λνΌ
- β… `withCreator()`: ν¬λ¦¬μ—μ΄ν„° μ „μ© API λνΌ

#### μ‚¬μ© μμ‹

##### μμ‹ 1: μΈμ¦μ΄ ν•„μ”ν• API
```typescript
import { withAuth } from '@/lib/security/auth-middleware';

export const POST = withAuth(async (request: NextRequest, auth) => {
  // auth.userId, auth.role μ‚¬μ© κ°€λ¥
  return NextResponse.json({ success: true, userId: auth.userId });
});
```

##### μμ‹ 2: κ΄€λ¦¬μ μ „μ© API
```typescript
import { withAdmin } from '@/lib/security/auth-middleware';

export const DELETE = withAdmin(async (request: NextRequest, auth) => {
  // κ΄€λ¦¬μλ§ μ ‘κ·Ό κ°€λ¥
  return NextResponse.json({ success: true });
});
```

##### μμ‹ 3: ν¬λ¦¬μ—μ΄ν„° μ „μ© API
```typescript
import { withCreator } from '@/lib/security/auth-middleware';

export const PATCH = withCreator(
  async (request: NextRequest, auth) => {
    // auth.bjId μ‚¬μ© κ°€λ¥
    return NextResponse.json({ success: true, bjId: auth.bjId });
  },
  (request) => {
    // streamId μ¶”μ¶ λ΅μ§
    return request.nextUrl.searchParams.get('streamId') || undefined;
  }
);
```

---

## π“¦ μ„¤μΉ ν•„μ” ν¨ν‚¤μ§€

λ‹¤μ λ…λ Ήμ–΄λ΅ ν•„μ”ν• ν¨ν‚¤μ§€λ¥Ό μ„¤μΉν•μ„Έμ”:

```bash
npm install crypto-js
npm install --save-dev webpack-obfuscator @types/crypto-js
```

---

## π”§ ν™κ²½ λ³€μ μ„¤μ •

`.env.local` νμΌμ— λ‹¤μ ν™κ²½ λ³€μλ¥Ό μ¶”κ°€ν•μ„Έμ”:

```env
# μ•”νΈν™” ν‚¤ (ν”„λ΅λ•μ…μ—μ„λ” λ°λ“μ‹ λ³€κ²½)
ENCRYPTION_KEY=your-secure-encryption-key-change-this-in-production

# Supabase μ„¤μ • (κΈ°μ΅΄)
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
```

---

## π€ μ μ© λ°©λ²•

### 1. κΈ°μ΅΄ API Routeμ— λ³΄μ• λ―Έλ“¤μ›¨μ–΄ μ μ©

κΈ°μ΅΄ API Routeλ¥Ό λ‹¤μκ³Ό κ°™μ΄ μμ •:

```typescript
// Before
export async function POST(request: Request) {
  const body = await request.json();
  // ... μ²λ¦¬ λ΅μ§
  return NextResponse.json({ success: true });
}

// After
import { securityMiddleware, createSecureResponse, RATE_LIMITS } from '@/lib/security/middleware';
import { withAuth } from '@/lib/security/auth-middleware';

export const POST = withAuth(async (request: NextRequest, auth) => {
  // λ³΄μ• λ―Έλ“¤μ›¨μ–΄ μ‹¤ν–‰
  const securityCheck = await securityMiddleware(request, {
    rateLimit: RATE_LIMITS.GENERAL,
    checkSQLInjection: true,
    checkXSS: true,
  });
  
  if (securityCheck) {
    return securityCheck;
  }
  
  const body = await request.json();
  // ... μ²λ¦¬ λ΅μ§
  
  return createSecureResponse({ success: true });
});
```

### 2. ν”„λ΅λ•μ… λΉλ“ μ‹ λ‚λ…ν™” μ μ©

```bash
# λ‚λ…ν™” λΉλ“
npm run build:obfuscated

# λ°°ν¬
npm start
```

---

## π“ μ°Έκ³  μ‚¬ν•­

### Rate Limiting
- ν„μ¬λ” μΈλ©”λ¨λ¦¬ μ €μ¥μ†λ¥Ό μ‚¬μ©ν•©λ‹λ‹¤.
- ν”„λ΅λ•μ… ν™κ²½μ—μ„λ” Redisλ¥Ό μ‚¬μ©ν•λ” κ²ƒμ„ κ¶μ¥ν•©λ‹λ‹¤.
- `src/lib/security/rate-limiter.ts`λ¥Ό μμ •ν•μ—¬ Redis μ—°λ™ κ°€λ¥ν•©λ‹λ‹¤.

### μ•”νΈν™” ν‚¤ κ΄€λ¦¬
- ν”„λ΅λ•μ… ν™κ²½μ—μ„λ” λ°λ“μ‹ κ°•λ ¥ν• μ•”νΈν™” ν‚¤λ¥Ό μ‚¬μ©ν•μ„Έμ”.
- ν™κ²½ λ³€μλ΅ κ΄€λ¦¬ν•κ³ , μ λ€ μ½”λ“μ— ν•λ“μ½”λ”©ν•μ§€ λ§μ„Έμ”.

### λ³΄μ• ν—¤λ”
- `src/middleware.ts`μ—μ„ μλ™μΌλ΅ λ¨λ“  μ‘λ‹µμ— λ³΄μ• ν—¤λ”κ°€ μ¶”κ°€λ©λ‹λ‹¤.
- ν•„μ”μ— λ”°λΌ CSP μ •μ±…μ„ μ΅°μ •ν•μ„Έμ”.

### μ½”λ“ λ‚λ…ν™”
- λ‚λ…ν™”λ” ν”„λ΅λ•μ… λΉλ“μ—λ§ μ μ©λ©λ‹λ‹¤.
- κ°λ° ν™κ²½μ—μ„λ” μ μ©λμ§€ μ•μΌλ―€λ΅ λ””λ²„κΉ…μ΄ κ°€λ¥ν•©λ‹λ‹¤.
- λ‚λ…ν™”λ μ½”λ“λ” μ„±λ¥μ— μ•½κ°„μ μν–¥μ„ μ¤„ μ μμµλ‹λ‹¤.

---

## π” λ³΄μ• μ²΄ν¬λ¦¬μ¤νΈ

- [x] μ½”λ“ λ‚λ…ν™” μ„¤μ • μ™„λ£
- [x] μ•”νΈν™” μ ν‹Έλ¦¬ν‹° κµ¬ν„ μ™„λ£
- [x] λ³΄μ• ν—¤λ” μ„¤μ • μ™„λ£
- [x] Rate Limiting κµ¬ν„ μ™„λ£
- [x] SQL Injection λ°©μ§€ κµ¬ν„ μ™„λ£
- [x] XSS λ°©μ§€ κµ¬ν„ μ™„λ£
- [x] μ”μ²­ ν¬κΈ° μ ν• κµ¬ν„ μ™„λ£
- [x] JWT ν† ν° λ³΄μ• κ°•ν™” μ™„λ£
- [x] μΈμ¦ λ―Έλ“¤μ›¨μ–΄ κµ¬ν„ μ™„λ£
- [x] μ—­ν•  κΈ°λ° μ ‘κ·Ό μ μ–΄ κµ¬ν„ μ™„λ£
- [ ] μ‹¤μ  API Routeμ— λ³΄μ• λ―Έλ“¤μ›¨μ–΄ μ μ© (μλ™ μ‘μ—… ν•„μ”)
- [ ] ν”„λ΅λ•μ… ν™κ²½ λ³€μ μ„¤μ • (μλ™ μ‘μ—… ν•„μ”)
- [ ] Redis μ—°λ™ (μ„ νƒμ‚¬ν•­, ν”„λ΅λ•μ… κ¶μ¥)

---

## π“ μ¶”κ°€ λ¦¬μ†μ¤

- [Next.js Security Best Practices](https://nextjs.org/docs/app/building-your-application/configuring/security)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Webpack Obfuscator Documentation](https://github.com/javascript-obfuscator/webpack-obfuscator)
